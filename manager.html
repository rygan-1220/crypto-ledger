<!DOCTYPE html>
<html>

<head>
    <title>Department Manager Dashboard - CryptoLedger</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.7.1/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .v-application {
            font-family: 'Roboto', sans-serif;
        }

        .status-chip-pending {
            background-color: #FFF3E0 !important;
            color: #F57C00 !important;
        }

        .status-chip-approved {
            background-color: #E8F5E9 !important;
            color: #2E7D32 !important;
        }

        .status-chip-rejected {
            background-color: #FFEBEE !important;
            color: #C62828 !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <v-app>
            <!-- Navigation Drawer -->
            <v-navigation-drawer app permanent color="white" width="260" elevation="1">
                <div class="d-flex align-center pa-4 pl-6">
                    <v-avatar color="orange darken-2" size="40" class="mr-3">
                        <v-icon color="white">mdi-shield-lock</v-icon>
                    </v-avatar>
                    <div>
                        <div class="text-h6 font-weight-bold">CryptoLedger</div>
                        <div class="text-caption grey--text">Manager Portal</div>
                    </div>
                </div>

                <v-divider></v-divider>

                <v-list nav dense class="mt-4 px-4">
                    <v-list-item-group v-model="selectedItem" color="orange darken-2">
                        <v-list-item class="mb-2 rounded">
                            <v-list-item-icon>
                                <v-icon>mdi-view-dashboard</v-icon>
                            </v-list-item-icon>
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-medium">Dashboard</v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item class="mb-2 rounded">
                            <v-list-item-icon>
                                <v-icon>mdi-clock-check</v-icon>
                            </v-list-item-icon>
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-medium">Pending Approvals</v-list-item-title>
                            </v-list-item-content>
                            <v-list-item-action>
                                <v-chip x-small color="orange" text-color="white">{{ pendingCount }}</v-chip>
                            </v-list-item-action>
                        </v-list-item>
                        <v-list-item class="mb-2 rounded">
                            <v-list-item-icon>
                                <v-icon>mdi-account-group</v-icon>
                            </v-list-item-icon>
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-medium">Manage Team</v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                        <v-list-item class="mb-2 rounded">
                            <v-list-item-icon>
                                <v-icon>mdi-history</v-icon>
                            </v-list-item-icon>
                            <v-list-item-content>
                                <v-list-item-title class="font-weight-medium">Approval History</v-list-item-title>
                            </v-list-item-content>
                        </v-list-item>
                    </v-list-item-group>
                </v-list>

                <template v-slot:append>
                    <div class="pa-4">
                        <v-card class="rounded pa-3 mb-3" color="orange lighten-5" elevation="0">
                            <div class="d-flex align-center">
                                <v-icon color="success" class="mr-2">mdi-shield-check</v-icon>
                                <div>
                                    <div class="caption font-weight-bold">E2E Encryption Active</div>
                                    <div class="caption grey--text text--darken-1">Engineering Department</div>
                                </div>
                            </div>
                        </v-card>
                        <v-btn block color="error" text large href="index.html">
                            <v-icon left>mdi-logout</v-icon> Logout
                        </v-btn>
                    </div>
                </template>
            </v-navigation-drawer>

            <!-- App Bar -->
            <v-app-bar app color="white" elevation="0"
                style="border-bottom: 1px solid #e0e0e0 !important; height: 64px;">
                <v-toolbar-title class="font-weight-bold text-h6 ml-2">
                    {{ pageTitle }}
                </v-toolbar-title>
                <v-spacer></v-spacer>
                <div class="d-flex align-center mr-4">
                    <v-btn icon class="mr-2">
                        <v-badge color="error" :content="pendingCount" overlap>
                            <v-icon>mdi-bell-outline</v-icon>
                        </v-badge>
                    </v-btn>
                    <v-avatar color="grey lighten-4" size="40" class="mr-3">
                        <v-icon color="orange darken-2">mdi-account-tie</v-icon>
                    </v-avatar>
                    <div class="d-none d-sm-block text-right">
                        <div class="subtitle-2 font-weight-bold black--text mb-0">{{ currentUser.name }}</div>
                        <div class="caption grey--text mt-0">{{ currentUser.email }}</div>
                    </div>
                </div>
            </v-app-bar>

            <!-- Main Content -->
            <v-main class="grey lighten-4">
                <v-container class="pa-6" fluid>
                    <!-- Dashboard Page -->
                    <div v-if="selectedItem === 0">
                        <!-- Stats Row -->
                        <v-row class="mb-4">
                            <v-col cols="12" sm="6" md="3">
                                <v-card class="pa-2" elevation="0">
                                    <v-list-item three-line>
                                        <v-list-item-content>
                                            <div class="overline mb-4 grey--text">Team Total (Month)</div>
                                            <v-list-item-title class="text-h4 font-weight-bold primary--text mb-1">
                                                RM {{ stats.total.toLocaleString() }}
                                            </v-list-item-title>
                                        </v-list-item-content>
                                        <v-list-item-avatar tile size="80" color="blue lighten-5" class="rounded">
                                            <v-icon x-large color="primary">mdi-cash-multiple</v-icon>
                                        </v-list-item-avatar>
                                    </v-list-item>
                                </v-card>
                            </v-col>
                            <v-col cols="12" sm="6" md="3">
                                <v-card class="pa-2" elevation="0">
                                    <v-list-item three-line>
                                        <v-list-item-content>
                                            <div class="overline mb-4 grey--text">Pending Approvals</div>
                                            <v-list-item-title class="text-h4 font-weight-bold orange--text mb-1">
                                                {{ stats.pending }}
                                            </v-list-item-title>
                                        </v-list-item-content>
                                        <v-list-item-avatar tile size="80" color="orange lighten-5" class="rounded">
                                            <v-icon x-large color="orange">mdi-clock-alert</v-icon>
                                        </v-list-item-avatar>
                                    </v-list-item>
                                </v-card>
                            </v-col>
                            <v-col cols="12" sm="6" md="3">
                                <v-card class="pa-2" elevation="0">
                                    <v-list-item three-line>
                                        <v-list-item-content>
                                            <div class="overline mb-4 grey--text">Approved</div>
                                            <v-list-item-title class="text-h4 font-weight-bold success--text mb-1">
                                                {{ stats.approved }}
                                            </v-list-item-title>
                                        </v-list-item-content>
                                        <v-list-item-avatar tile size="80" color="green lighten-5" class="rounded">
                                            <v-icon x-large color="success">mdi-check-circle</v-icon>
                                        </v-list-item-avatar>
                                    </v-list-item>
                                </v-card>
                            </v-col>
                            <v-col cols="12" sm="6" md="3">
                                <v-card class="pa-2" elevation="0">
                                    <v-list-item three-line>
                                        <v-list-item-content>
                                            <div class="overline mb-4 grey--text">Team Members</div>
                                            <v-list-item-title class="text-h4 font-weight-bold info--text mb-1">
                                                {{ stats.teamMembers }}
                                            </v-list-item-title>
                                        </v-list-item-content>
                                        <v-list-item-avatar tile size="80" color="light-blue lighten-5" class="rounded">
                                            <v-icon x-large color="info">mdi-account-group</v-icon>
                                        </v-list-item-avatar>
                                    </v-list-item>
                                </v-card>
                            </v-col>
                        </v-row>

                        <!-- Budget Overview -->
                        <v-row class="mb-4">
                            <v-col cols="12">
                                <v-card class="rounded-card" elevation="0">
                                    <v-toolbar flat color="white" class="px-4 py-2" height="auto">
                                        <div>
                                            <div class="text-h6 font-weight-bold">Department Budget Overview</div>
                                            <div class="caption grey--text">Engineering Department</div>
                                        </div>
                                    </v-toolbar>
                                    <v-divider></v-divider>
                                    <v-card-text class="pa-6">
                                        <div class="d-flex justify-space-between mb-2">
                                            <span class="font-weight-medium">Budget Utilization</span>
                                            <span class="font-weight-bold">{{ budgetPercent }}%</span>
                                        </div>
                                        <v-progress-linear :value="budgetPercent" height="25" rounded
                                            :color="budgetPercent > 80 ? 'error' : budgetPercent > 60 ? 'warning' : 'success'">
                                            <template v-slot:default="{ value }">
                                                <strong class="white--text">{{ Math.ceil(value) }}%</strong>
                                            </template>
                                        </v-progress-linear>
                                        <div class="d-flex justify-space-between mt-3">
                                            <div>
                                                <div class="caption grey--text">Spent</div>
                                                <div class="font-weight-bold">RM {{ department.spent.toLocaleString() }}
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="caption grey--text">Budget</div>
                                                <div class="font-weight-bold">RM {{ department.budget.toLocaleString()
                                                    }}</div>
                                            </div>
                                        </div>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>

                        <!-- Recent Approvals -->
                        <v-row>
                            <v-col cols="12">
                                <v-card class="rounded-card" elevation="0">
                                    <v-toolbar flat color="white" class="px-4 py-2" height="auto">
                                        <div>
                                            <div class="text-h6 font-weight-bold">Recent Approval Activity</div>
                                            <div class="caption grey--text">Latest department reimbursements</div>
                                        </div>
                                    </v-toolbar>
                                    <v-divider></v-divider>
                                    <v-simple-table>
                                        <template v-slot:default>
                                            <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Description</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="item in recentActivity" :key="item.id">
                                                    <td>
                                                        <div class="d-flex align-center py-2">
                                                            <v-avatar color="blue lighten-5" size="32" class="mr-3">
                                                                <span
                                                                    class="primary--text font-weight-bold text-caption">{{
                                                                    item.user_name.charAt(0) }}</span>
                                                            </v-avatar>
                                                            <span class="font-weight-medium">{{ item.user_name }}</span>
                                                        </div>
                                                    </td>
                                                    <td>{{ item.description }}</td>
                                                    <td class="font-weight-bold">RM {{ item.amount.toLocaleString() }}
                                                    </td>
                                                    <td>{{ item.date }}</td>
                                                    <td>
                                                        <v-chip small :class="'status-chip-' + item.status"
                                                            class="font-weight-medium">
                                                            {{ item.status.toUpperCase() }}
                                                        </v-chip>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </template>
                                    </v-simple-table>
                                </v-card>
                            </v-col>
                        </v-row>
                    </div>

                    <!-- Pending Approvals Page -->
                    <div v-if="selectedItem === 1">
                        <v-row>
                            <v-col cols="12">
                                <v-card class="rounded-card" elevation="0">
                                    <v-toolbar flat color="white" class="px-4 py-2" height="auto">
                                        <div>
                                            <div class="text-h6 font-weight-bold">Pending Approvals</div>
                                            <div class="caption grey--text">Review and approve team reimbursements</div>
                                        </div>
                                        <v-spacer></v-spacer>
                                        <v-text-field v-model="search" prepend-inner-icon="mdi-magnify"
                                            label="Search..." single-line hide-details outlined dense class="mr-4"
                                            style="max-width: 250px" background-color="grey lighten-5"></v-text-field>
                                    </v-toolbar>
                                    <v-divider></v-divider>
                                    <v-data-table :headers="approvalHeaders" :items="pendingApprovals" :search="search"
                                        class="elevation-0" show-expand>
                                        <template v-slot:item.id="{ item }">
                                            <span class="font-weight-bold grey--text text--darken-3">#{{ item.id
                                                }}</span>
                                        </template>

                                        <template v-slot:item.user_name="{ item }">
                                            <div class="d-flex align-center py-2">
                                                <v-avatar color="blue lighten-5" size="32" class="mr-3">
                                                    <span class="primary--text font-weight-bold text-caption">{{
                                                        item.user_name.charAt(0) }}</span>
                                                </v-avatar>
                                                <span class="font-weight-medium">{{ item.user_name }}</span>
                                            </div>
                                        </template>

                                        <template v-slot:item.amount="{ item }">
                                            <span class="font-weight-bold">RM {{ item.amount.toLocaleString() }}</span>
                                        </template>

                                        <template v-slot:item.category="{ item }">
                                            <v-chip small label color="blue lighten-5" text-color="primary"
                                                class="font-weight-medium">
                                                {{ item.category }}
                                            </v-chip>
                                        </template>

                                        <template v-slot:item.days_pending="{ item }">
                                            <v-chip small label
                                                :color="getDaysPending(item.submitted_date) > 3 ? 'error' : 'grey'"
                                                :text-color="getDaysPending(item.submitted_date) > 3 ? 'white' : 'black'">
                                                {{ getDaysPending(item.submitted_date) }} days
                                            </v-chip>
                                        </template>

                                        <template v-slot:item.actions="{ item }">
                                            <div class="d-flex" style="gap: 8px;">
                                                <v-btn small color="success" depressed @click="approveRequest(item)">
                                                    <v-icon small left>mdi-check</v-icon>
                                                    Approve
                                                </v-btn>
                                                <v-btn small color="error" outlined @click="openRejectDialog(item)">
                                                    <v-icon small left>mdi-close</v-icon>
                                                    Reject
                                                </v-btn>
                                            </div>
                                        </template>

                                        <template v-slot:expanded-item="{ headers, item }">
                                            <td :colspan="headers.length" class="pa-4 grey lighten-5">
                                                <v-row>
                                                    <v-col cols="12" md="8">
                                                        <div class="mb-2"><strong>Description:</strong> {{
                                                            item.description }}</div>
                                                        <div class="mb-2"><strong>Vendor:</strong> {{ item.vendor }}
                                                        </div>
                                                        <div class="mb-2"><strong>Project:</strong> {{ item.project_name
                                                            }}</div>
                                                        <div class="mb-2"><strong>Submitted:</strong> {{
                                                            item.submitted_date }}</div>
                                                    </v-col>
                                                    <v-col cols="12" md="4">
                                                        <v-card elevation="0">
                                                            <v-card-text>
                                                                <div class="caption grey--text mb-1">Security Status
                                                                </div>
                                                                <div class="d-flex align-center mb-2">
                                                                    <v-icon small color="success"
                                                                        class="mr-2">mdi-shield-check</v-icon>
                                                                    <span class="caption">Signature Verified &
                                                                        Encrypted</span>
                                                                </div>
                                                            </v-card-text>
                                                        </v-card>
                                                    </v-col>
                                                </v-row>
                                            </td>
                                        </template>

                                        <template v-slot:no-data>
                                            <div class="pa-8 text-center grey--text">
                                                <v-icon size="64" color="grey lighten-2">mdi-check-all</v-icon>
                                                <div class="mt-2 text-body-1">No pending approvals</div>
                                            </div>
                                        </template>
                                    </v-data-table>
                                </v-card>
                            </v-col>
                        </v-row>
                    </div>

                    <!-- Manage Team Page -->
                    <div v-if="selectedItem === 2">
                        <v-row>
                            <v-col cols="12">
                                <v-card class="rounded-card" elevation="0">
                                    <v-toolbar flat color="white" class="px-4 py-2" height="auto">
                                        <div>
                                            <div class="text-h6 font-weight-bold">Engineering Department Team Members
                                            </div>
                                            <div class="caption grey--text">Manage your team and allocate members</div>
                                        </div>
                                        <v-spacer></v-spacer>
                                        <v-text-field v-model="teamSearch" prepend-inner-icon="mdi-magnify"
                                            label="Search by name or email..." single-line hide-details outlined dense
                                            class="mr-4" style="max-width: 300px"
                                            background-color="grey lighten-5"></v-text-field>
                                        <v-btn color="primary" depressed @click="addMemberDialog = true">
                                            <v-icon left>mdi-account-plus</v-icon>
                                            Add Member
                                        </v-btn>
                                    </v-toolbar>
                                    <v-divider></v-divider>
                                    <v-card-text class="pa-6">
                                        <v-row>
                                            <v-col cols="12" md="6" v-for="member in teamMembers" :key="member.id">
                                                <v-card outlined class="rounded">
                                                    <v-list-item three-line>
                                                        <v-list-item-avatar size="60" color="blue lighten-5">
                                                            <span class="primary--text text-h5 font-weight-bold">{{
                                                                member.name.charAt(0) }}</span>
                                                        </v-list-item-avatar>
                                                        <v-list-item-content>
                                                            <v-list-item-title class="font-weight-bold mb-1">{{
                                                                member.name }}</v-list-item-title>
                                                            <v-list-item-subtitle>{{ member.email
                                                                }}</v-list-item-subtitle>
                                                            <div class="mt-2">
                                                                <v-chip x-small color="success" text-color="white"
                                                                    class="mr-1">
                                                                    <v-icon x-small left>mdi-key</v-icon>
                                                                    K_real Distributed
                                                                </v-chip>
                                                            </div>
                                                        </v-list-item-content>
                                                        <v-list-item-action>
                                                            <div class="text-center">
                                                                <div class="caption grey--text">Total Submitted</div>
                                                                <div class="font-weight-bold">{{
                                                                    getMemberStats(member.id).count }}</div>
                                                            </div>
                                                        </v-list-item-action>
                                                    </v-list-item>
                                                </v-card>
                                            </v-col>
                                        </v-row>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>
                    </div>

                    <!-- Approval History Page -->
                    <div v-if="selectedItem === 3">
                        <v-row>
                            <v-col cols="12">
                                <v-card class="rounded-card" elevation="0">
                                    <v-toolbar flat color="white" class="px-4 py-2" height="auto">
                                        <div>
                                            <div class="text-h6 font-weight-bold">Approval History</div>
                                            <div class="caption grey--text">All department reimbursements</div>
                                        </div>
                                        <v-spacer></v-spacer>
                                        <v-select v-model="historyStatusFilter" :items="historyStatusOptions"
                                            label="Filter by Status" outlined dense hide-details class="mr-4"
                                            style="max-width: 200px" background-color="grey lighten-5"></v-select>
                                        <v-text-field v-model="historySearch" prepend-inner-icon="mdi-magnify"
                                            label="Search..." single-line hide-details outlined dense
                                            style="max-width: 250px" background-color="grey lighten-5"></v-text-field>
                                    </v-toolbar>
                                    <v-divider></v-divider>
                                    <v-data-table :headers="historyHeaders" :items="filteredHistoryReimbursements"
                                        :search="historySearch" class="elevation-0" show-expand>
                                        <template v-slot:item.id="{ item }">
                                            <span class="font-weight-bold grey--text text--darken-3">#{{ item.id
                                                }}</span>
                                        </template>

                                        <template v-slot:item.user_name="{ item }">
                                            <div class="d-flex align-center py-2">
                                                <v-avatar color="blue lighten-5" size="32" class="mr-3">
                                                    <span class="primary--text font-weight-bold text-caption">{{
                                                        item.user_name.charAt(0) }}</span>
                                                </v-avatar>
                                                <span class="font-weight-medium">{{ item.user_name }}</span>
                                            </div>
                                        </template>

                                        <template v-slot:item.amount="{ item }">
                                            <span class="font-weight-bold">RM {{ item.amount.toLocaleString() }}</span>
                                        </template>

                                        <template v-slot:item.category="{ item }">
                                            <v-chip small label color="blue lighten-5" text-color="primary"
                                                class="font-weight-medium">
                                                {{ item.category }}
                                            </v-chip>
                                        </template>

                                        <template v-slot:item.status="{ item }">
                                            <v-chip small :class="'status-chip-' + item.status"
                                                class="font-weight-medium">
                                                {{ item.status.toUpperCase() }}
                                            </v-chip>
                                        </template>

                                        <template v-slot:expanded-item="{ headers, item }">
                                            <td :colspan="headers.length" class="pa-4 grey lighten-5">
                                                <v-row>
                                                    <v-col cols="12" md="8">
                                                        <div class="mb-2"><strong>Description:</strong> {{
                                                            item.description }}</div>
                                                        <div class="mb-2"><strong>Vendor:</strong> {{ item.vendor }}
                                                        </div>
                                                        <div class="mb-2"><strong>Project:</strong> {{ item.project_name
                                                            }}</div>
                                                        <div class="mb-2"><strong>Submitted:</strong> {{
                                                            item.submitted_date }}</div>
                                                    </v-col>
                                                    <v-col cols="12" md="4">
                                                        <v-card elevation="0">
                                                            <v-card-text>
                                                                <div class="caption grey--text mb-1">Security Status
                                                                </div>
                                                                <div class="d-flex align-center mb-2">
                                                                    <v-icon small color="success"
                                                                        class="mr-2">mdi-shield-check</v-icon>
                                                                    <span class="caption">Signature Verified &
                                                                        Encrypted</span>
                                                                </div>
                                                            </v-card-text>
                                                        </v-card>
                                                    </v-col>
                                                </v-row>
                                            </td>
                                        </template>
                                    </v-data-table>
                                </v-card>
                            </v-col>
                        </v-row>
                    </div>
                </v-container>
            </v-main>

            <!-- Reject Dialog -->
            <v-dialog v-model="rejectDialog" max-width="500px">
                <v-card class="rounded">
                    <v-card-title class="pa-4 pl-6 border-bottom grey lighten-5">
                        <span class="text-h6 font-weight-bold">Reject Reimbursement</span>
                    </v-card-title>
                    <v-divider></v-divider>
                    <v-card-text class="pa-6">
                        <v-alert type="warning" text dense class="mb-4">
                            Please provide a reason for rejection
                        </v-alert>
                        <v-textarea v-model="rejectReason" label="Rejection Reason" outlined rows="4"
                            placeholder="Explain why this reimbursement is being rejected..."></v-textarea>
                    </v-card-text>
                    <v-divider></v-divider>
                    <v-card-actions class="pa-4">
                        <v-spacer></v-spacer>
                        <v-btn text color="grey darken-1" @click="rejectDialog = false" class="px-4">Cancel</v-btn>
                        <v-btn color="error" depressed @click="confirmReject" class="px-6">Reject Request</v-btn>
                    </v-card-actions>
                </v-card>
            </v-dialog>

            <!-- Snackbar -->
            <v-snackbar v-model="snackbar.show" :color="snackbar.color" top right>
                <v-icon left color="white">{{ snackbar.icon }}</v-icon>
                {{ snackbar.text }}
            </v-snackbar>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.7.1/dist/vuetify.js"></script>
    <script src="js/mock-data.js"></script>
    <script src="js/manager.js"></script>
</body>

</html>